-- 1. PRZYGOTOWANIE ODPOWIEDNIEJ STRUKTURY BAZY DANYCH NA WYBRANY TEMAT
-- TABELE GLOWNE

CREATE TABLE UZYTKOWNICY
(
    ID_UZYTKOWNIKA  INT GENERATED ALWAYS AS IDENTITY (START WITH 1 INCREMENT BY 1) PRIMARY KEY,
    USERNAME     	VARCHAR2(30) NOT NULL,
    HASLO	     	VARCHAR2(30) NOT NULL,
    EMAIL        	VARCHAR2(30) NOT NULL,
    IMIE   		 	VARCHAR2(30) NOT NULL,
    NAZWISKO  	 	VARCHAR2(30) NOT NULL,
    TELEFON		 	VARCHAR2(30) NOT NULL,
    ID_ROLI      	INT          NOT NULL,
	ID_MARKA    	INT          NOT NULL,
	ID_NADWOZIA    	INT          NOT NULL,
    FOREIGN KEY (ID_MARKI) REFERENCES MARKA (ID_MARKI),
	FOREIGN KEY (ID_ROLI) REFERENCES USER_ROLE (ID_ROLI),
	FOREIGN KEY (ID_NADWOZIA) REFERENCES NADWOZIA (ID_NADWOZIA)
);

CREATE TABLE MARKA
(
	ID_MARKI  	INT GENERATED ALWAYS AS IDENTITY (START WITH 1 INCREMENT BY 1) PRIMARY KEY,
	NAZWA     	VARCHAR2(30) NOT NULL,
	ID_NADWOZIA   INT          NOT NULL,
    FOREIGN KEY (ID_NADWOZIA) REFERENCES NADWOZIE (ID_NADWOZIA)
);

CREATE TABLE NADWOZIE
(
	ID_NADWOZIA   INT GENERATED ALWAYS AS IDENTITY (START WITH 1 INCREMENT BY 1) PRIMARY KEY,
	NAZWA     	VARCHAR2(30) NOT NULL,
	OPIS     	VARCHAR2(30) NOT NULL
);

CREATE TABLE USER_ROLE
(
    ID_ROLI INT GENERATED ALWAYS AS IDENTITY (START WITH 1 INCREMENT BY 1) PRIMARY KEY,
    ROLA    VARCHAR2(30) NOT NULL
);

CREATE TABLE UPRAWNIENIA
(
    ID_UPR INT GENERATED ALWAYS AS IDENTITY (START WITH 1 INCREMENT BY 1) PRIMARY KEY,
    ID_ROLI           INT,
    ID_KLIENTA    INT,
    FOREIGN KEY (ID_ROLI) REFERENCES USER_ROLE (ID_ROLI),
    FOREIGN KEY (ID_UZYTKOWNIKA) REFERENCES UZYTKOWNICY (ID_UZYTKOWNIKA)
);

CREATE TABLE ODPOWIEDZI
(
	ID_ODP   	INT GENERATED ALWAYS AS IDENTITY (START WITH 1 INCREMENT BY 1) PRIMARY KEY,
	NAZWA     	VARCHAR2(30) NOT NULL
);

CREATE TABLE MODEL
(
	ID_MODELU   INT GENERATED ALWAYS AS IDENTITY (START WITH 1 INCREMENT BY 1) PRIMARY KEY,
	NAZWA     		VARCHAR2(30) NOT NULL,
    ID_MARKI   		INT		NOT NULL,
	ID_NADWOZIA   	INT		NOT NULL,
    FOREIGN KEY (ID_MARKI) REFERENCES MARKA (ID_MARKI),
	FOREIGN KEY (ID_NADWOZIA) REFERENCES NADWOZIE (ID_NADWOZIA)
);

CREATE TABLE PYTANIE
(
	ID_PYTANIA	    INT GENERATED ALWAYS AS IDENTITY (START WITH 1 INCREMENT BY 1) PRIMARY KEY,
    ID_MARKI   		INT,
	ID_NADWOZIA   	INT,
	ID_UZYTKOWNIKA	INT				NOT NULL,
	TRESC           VARCHAR2(100) 	NOT NULL,
	ID_MODELU	INT,
	ID_POPRAWNA		INT				NOT NULL,
    FOREIGN KEY (ID_MARKI) REFERENCES MARKA (ID_MARKI),
	FOREIGN KEY (ID_NADWOZIA) REFERENCES NADWOZIE (ID_NADWOZIA),
	FOREIGN KEY (ID_UZYTKOWNIKA) REFERENCES UZYTKOWNICY (ID_UZYTKOWNIKA),
	FOREIGN KEY (ID_MODELU) REFERENCES MODEL (ID_MODELU),
	FOREIGN KEY (ID_POPRAWNA) REFERENCES ODPOWIEDZI (ID_ODP)
);

CREATE TABLE TERMIN
(
	ID_TERMINU	    	INT GENERATED ALWAYS AS IDENTITY (START WITH 1 INCREMENT BY 1) PRIMARY KEY,
    ID_PYTANIA 			INT		NOT NULL,
	ID_UZYTKOWNIKA		INT		NOT NULL,
	UDZIELONA       	INT		NOT NULL,
	DATA_TERMINU			date	NOT NULL,
	DATA_WYPELNIENIA	INT		NOT NULL,
	UWAGI				VARCHAR2(60),
    FOREIGN KEY (ID_PYTANIA) REFERENCES PYTANIE (ID_PYTANIA),
	FOREIGN KEY (ID_UZYTKOWNIKA) REFERENCES UZYTKOWNICY (ID_UZYTKOWNIKA)
);

-- TABELE POMOCNICZE

CREATE TABLE UZYTKOWNICY_ARCHIVE
(
    ID_ARCHIVE         INT GENERATED ALWAYS AS IDENTITY (START WITH 1 INCREMENT BY 1) PRIMARY KEY,
    USERNAME           VARCHAR2(30) NOT NULL,
    HASLO   	       VARCHAR2(30) NOT NULL,
    EMAIL              VARCHAR2(30) NOT NULL,
    IMIE	           VARCHAR2(30),
    NAZWISKO           VARCHAR2(30),
    TELEFON		 	   VARCHAR2(30) NOT NULL,
	ID_ROLI      	   INT          NOT NULL,
	ID_MARKI    	   INT          NOT NULL,
	ID_NADWOZIA    	   INT          NOT NULL,
	DATA_AKCJI		   DATE,
	FOREIGN KEY (ID_ROLI) REFERENCES USER_ROLE (ID_ROLI),
    FOREIGN KEY (ID_MARKI) REFERENCES MARKA (ID_MARKI),
	FOREIGN KEY (ID_NADWOZIA) REFERENCES NADWOZIE (ID_NADWOZIA)
);

CREATE TABLE LOGI
(
    ID_LOGU         	INT GENERATED ALWAYS AS IDENTITY (START WITH 1 INCREMENT BY 1) PRIMARY KEY,
    OPERACJA  	    	VARCHAR2(30),
    DATA_OPERACJI   	DATE,
    TABELA			 	VARCHAR2(30)
);

-- WCZYTYWANIE DO BAZY PRZYKŁADOWYCH DANYCH

INSERT INTO USER_ROLE (ROLA)
VALUES ('ADMIN');
INSERT INTO USER_ROLE (ROLA)
VALUES ('WYPOZYCZALNIA');
INSERT INTO USER_ROLE (ROLA)
VALUES ('KLIENT');

INSERT INTO UZYTKOWNICY (USERNAME, HASLO, EMAIL, IMIE, NAZWISKO, TELEFON, ID_ROLI, ID_MARKI, ID_NADWOZIA)
VALUES ('jank', '123', 'j.kowalski@wp.pl', 'jan', 'kowalski', '+48-555-555-555', 1, 1, 1);
INSERT INTO UZYTKOWNICY (USERNAME, HASLO, EMAIL, IMIE, NAZWISKO, TELEFON, ID_ROLI, ID_MARKI, ID_NADWOZIA)
VALUES ('piotrn', '456', 'p.nowak@wp.pl', 'Piotr', 'Nowak', '+48-666-666-666', 2, 1, 1);
INSERT INTO UZYTKOWNICY (USERNAME, HASLO, EMAIL, IMIE, NAZWISKO, TELEFON, ID_ROLI, ID_MARKI, ID_NADWOZIA)
VALUES ('filipo', '789', 'f.okon', 'Filip', 'Okon', '+48-777-777-777', 3, 1, 2);

INSERT INTO UPRAWNIENIA (ID_ROLI, ID_UZYTKOWNIKA)
VALUES (1, 1);
INSERT INTO UPRAWNIENIA (ID_ROLI, ID_UZYTKOWNIKA)
VALUES (2, 2);
INSERT INTO UPRAWNIENIA (ID_ROLI, ID_UZYTKOWNIKA)
VALUES (3, 3);

INSERT INTO NADWOZIE (NAZWA, OPIS)
VALUES ('KOMBI', 'Samochod osobowy kombi');
INSERT INTO NADWOZIE (NAZWA, OPIS)
VALUES ('SEDAN', 'Samochod osobowy sedan');
INSERT INTO NADWOZIE (NAZWA, OPIS)
VALUES ('VAN', 'Samochod osobowy van');
INSERT INTO NADWOZIE (NAZWA, OPIS)
VALUES ('SUV', 'Samochod osobowy suv');

INSERT INTO MARKA (NAZWA, ID_WYPOZYCZALNIA)
VALUES ('Opel',1, 1);
INSERT INTO MARKA (NAZWA, ID_WYPOZYCZALNIA)
VALUES ('Fiat', 1, 2);
INSERT INTO MARKA (NAZWA, ID_WYPOZYCZALNIA)
VALUES ('VW', 1, 3);
INSERT INTO MARKA (NAZWA, ID_WYPOZYCZALNIA)
VALUES ('BMW', 2, 1);

INSERT INTO MODEL (NAZWA, ID_MARKA, ID_WYPOZYCZALNIA)
VALUES ('Insignia',1, 1);
INSERT INTO MODEL (NAZWA, ID_MARKA, ID_WYPOZYCZALNIA)
VALUES ('Tipo',1, 1);
INSERT INTO MODEL (NAZWA, ID_MARKA, ID_WYPOZYCZALNIA)
VALUES ('California',1, 1);
INSERT INTO MODEL (NAZWA, ID_MARKA, ID_WYPOZYCZALNIA)
VALUES ('X5',1, 1);


INSERT INTO PYTANIE (ID_MARKI, ID_NADWOZIA, ID_UZYTKOWNIKA, TRESC, ID_MODELU,)
VALUES (1, 1, 2, 'Na jak długo chcesz wynająć samochód',1, 1, 1);

INSERT INTO ODPOWIEDZI (NAZWA)
VALUES ('Na jeden dzien');
INSERT INTO ODPOWIEDZI (NAZWA)
VALUES ('Do tygodnia');
INSERT INTO ODPOWIEDZI (NAZWA)
VALUES ('Do dwoch tygodni');
INSERT INTO ODPOWIEDZI (NAZWA)
VALUES ('Do miesiaca');
INSERT INTO ODPOWIEDZI (NAZWA)
VALUES ('Nie wiem, ale wiecej niz miesiac');


-- PROCEDURY, FUNKCJE, WYZWALACZE OBSLUGUJACE BAZE

-- DODAWANIE REKORDOW

CREATE OR REPLACE PROCEDURE dodaj_uzytkownika
(	V_USERNAME 		VARCHAR2,
	V_HASLO 		VARCHAR2,
    V_EMAIL 		VARCHAR2,
    V_IMIE 			VARCHAR2 DEFAULT '',
    V_NAZWISKO 		VARCHAR2 DEFAULT '',
    V_TELEFON 		VARCHAR2 DEFAULT '',
    V_ID_ROLI 		INT DEFAULT NULL,
	V_ID_MARKI 		INT DEFAULT NULL,
	V_ID_NADWOZIA 	INT DEFAULT NULL
)
IS
BEGIN
    INSERT INTO UZYTKOWNICY (USERNAME, HASLO, EMAIL, IMIE, NAZWISKO, TELEFON, ID_ROLI, ID_MARKI, ID_NADWOZIA)
    VALUES (V_USERNAME, V_HASLO, V_EMAIL, V_IMIE, V_NAZWISKO, V_TELEFON, V_ID_ROLI, V_ID_MARKI, V_ID_NADWOZIA);

EXCEPTION
    WHEN OTHERS THEN
        DBMS_OUTPUT.PUT_LINE('Błędne dane');
        DBMS_OUTPUT.PUT_LINE('Kod błedu: ' || SQLCODE);
        DBMS_OUTPUT.PUT_LINE('Komunikat: ' || SQLERRM);
END;

-- AKTUALIZACJA REKORDOW

CREATE OR REPLACE PROCEDURE ZMIEN_HASLO 
(
	V_ID_UZYTKOWNIKA 	INT,
    V_NEW_HASLO 		VARCHAR2
)
IS
BEGIN
    UPDATE UZYTKOWNICY SET HASLO = V_NEW_HASLO WHERE ID_UZYTKOWNIKA = V_ID_UZYTKOWNIKA;
    IF SQL%ROWCOUNT = 0 THEN
        RAISE_APPLICATION_ERROR(-20001, 'Nie zaktualizowano żadnych danych');
    END IF;

EXCEPTION
    WHEN OTHERS THEN
         DBMS_OUTPUT.PUT_LINE('błędne dane');
         DBMS_OUTPUT.PUT_LINE('Kod błedu: ' || SQLCODE);
         DBMS_OUTPUT.PUT_LINE('Komunikat: ' || SQLERRM);
END;

-- USUWANIE REKORDOW

CREATE OR REPLACE PROCEDURE USUN_UZYTKOWNIKA
(
	V_ID_UZYTKOWNIKA INT)
    IS
    NO_ROWS_DELETED EXCEPTION;
    PRAGMA EXCEPTION_INIT (NO_ROWS_DELETED, -2001
);
BEGIN
    DELETE FROM UZYTKOWNICY WHERE ID_UZYTKOWNIKA = V_ID_UZYTKOWNIKA;
    IF SQL%ROWCOUNT = 0 THEN
        RAISE_APPLICATION_ERROR(-20001, 'Nie usunieto żadnych danych');
    END IF;
EXCEPTION
    WHEN NO_ROWS_DELETED THEN
		 DBMS_OUTPUT.PUT_LINE(SQLERRM);
    WHEN OTHERS THEN
         DBMS_OUTPUT.PUT_LINE('Błędne dane');
         DBMS_OUTPUT.PUT_LINE('Kod błedu: ' || SQLCODE);
         DBMS_OUTPUT.PUT_LINE('Komunikat: ' || SQLERRM);
END;

-- ARCHIWUM USUNIETYCH DANYCH


CREATE OR REPLACE TRIGGER UZYTKOWNICY_ARCHIWIZACJA
    BEFORE DELETE
    ON UZYTKOWNICY
    FOR EACH ROW
BEGIN
    INSERT INTO UZYTKOWNICY_ARCHIVE (USERNAME, HASLO, EMAIL, IMIE, NAZWISKO, TELEFON, ID_ROLI, ID_MARKI, ID_NADWOZIA,
    DATA_AKCJI)
    VALUES (:OLD.USERNAME, :OLD.HASLO, :OLD.EMAIL, :OLD.IMIE, :OLD.NAZWISKO, :OLD.TELEFON, :OLD.ID_ROLI,
    :OLD.ID_MARKI, :OLD.ID_NADWOZIA, CURRENT_DATE);
END;

-- LOGOWANIE INFORMACJI DO TABELI

CREATE OR REPLACE TRIGGER LOGI_USUWANIE_UZYTKOWNIKA
    AFTER DELETE
    ON UZYTKOWNICY
BEGIN
    INSERT INTO LOGI (OPERACJA, DATA_OPERACJI, TABELA)
    VALUES ('USUNIECIE', CURRENT_DATE, 'UZYTKOWNICY');
END;

CREATE OR REPLACE TRIGGER LOGI_DODANIE_UZYTKOWNIKA
    AFTER INSERT
    ON UZYTKOWNICY
BEGIN
    INSERT INTO LOGI (OPERACJA, DATA_OPERACJI, TABELA)
    VALUES ('DODANIE', CURRENT_DATE, 'UZYTKOWNICY');
END;

CREATE OR REPLACE TRIGGER LOGI_AKTUALIZACJA_UZYTKOWNIKA
    AFTER UPDATE
    ON UZYTKOWNICY
BEGIN
    INSERT INTO LOGS (OPERACJA, DATA_OPERACJI, TABELA)
    VALUES ('AKTUALIZACJA', CURRENT_DATE, 'UZYTKOWNICY');
END;

-- SPRAWDZANIE E-MAILA

CREATE OR REPLACE FUNCTION SPRAWDZ_EMAIL (V_EMAIL VARCHAR2) RETURN BOOLEAN IS
BEGIN
    IF V_EMAIL NOT LIKE '_%@__%.__%' THEN
        RETURN FALSE;
    ELSE
        RETURN TRUE;
    END IF;
END;
